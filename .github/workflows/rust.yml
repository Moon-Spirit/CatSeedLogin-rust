name: Build CatSeedLogin Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      changelog:
        description: 'æ›´æ–°å†…å®¹ (ä¿®å¤çš„bugå’Œæ–°å¢åŠŸèƒ½)'
        required: true
        default: 'ä¿®å¤å·²çŸ¥é—®é¢˜ï¼Œä¼˜åŒ–æ€§èƒ½'

env:
  CARGO_NET_GIT_FETCH_WITH_CLI: true
  RUSTFLAGS: "-A warnings"

jobs:
  get-version:
    name: Get Version from Cargo.toml
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Extract version from Cargo.toml
      id: get-version
      shell: bash
      run: |
        # ä»Cargo.tomlæ–‡ä»¶ä¸­æå–ç‰ˆæœ¬å·
        if [ -f "Cargo.toml" ]; then
          VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "ä»Cargo.tomlä¸­æå–çš„ç‰ˆæœ¬å·: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°Cargo.tomlæ–‡ä»¶"
          exit 1
        fi

  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: get-version
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            platform: windows
            file_extension: dll
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux
            file_extension: so
          - os: macos-latest
            target: x86_64-apple-darwin
            platform: macos
            file_extension: dylib
      fail-fast: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: ${{ matrix.target }}
        profile: minimal

    - name: Add Rust target
      run: rustup target add ${{ matrix.target }}

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Build release
      run: cargo build --release --target ${{ matrix.target }}

    - name: Find library file
      shell: bash
      run: |
        # æŸ¥æ‰¾æ„å»ºå‡ºçš„åº“æ–‡ä»¶
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dll" -type f | head -1)
        elif [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.so" -type f | head -1)
        else
          LIB_FILE=$(find target/${{ matrix.target }}/release -name "*.dylib" -type f | head -1)
        fi
        
        if [ -z "$LIB_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ°åº“æ–‡ä»¶ï¼Œæ£€æŸ¥æ‰€æœ‰æ–‡ä»¶:"
          find target/${{ matrix.target }}/release -type f
          exit 1
        fi
        
        echo "âœ… æ‰¾åˆ°åº“æ–‡ä»¶: $LIB_FILE"
        
        # å‡†å¤‡æ–‡ä»¶å
        VERSION="${{ needs.get-version.outputs.version }}"
        ARTIFACT_NAME="CatSeedLogin_v${VERSION}_${{ matrix.platform }}.${{ matrix.file_extension }}"
        
        mkdir -p dist
        cp "$LIB_FILE" "dist/$ARTIFACT_NAME"
        echo "artifact_name=$ARTIFACT_NAME" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: Upload to CI Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CatSeedLogin-v${{ env.version }}-${{ matrix.platform }}
        path: dist/${{ env.artifact_name }}
        retention-days: 90

  create-summary:
    name: Create Build Summary
    runs-on: ubuntu-latest
    needs: [get-version, build]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
        pattern: CatSeedLogin-*
        merge-multiple: true

    - name: Create summary
      shell: bash
      run: |
        VERSION="${{ needs.get-version.outputs.version }}"
        CHANGELOG="${{ github.event.inputs.changelog || 'ä¿®å¤å·²çŸ¥é—®é¢˜ï¼Œä¼˜åŒ–æ€§èƒ½' }}"
        
        echo "# ğŸ± CatSeedLogin v${VERSION} æ„å»ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“‹ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${GITHUB_SHA:0:7}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ”§ æ›´æ–°å†…å®¹" >> $GITHUB_STEP_SUMMARY
        echo "$CHANGELOG" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## ğŸ“¦ ä¸‹è½½é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "æ„ä»¶å·²ä¸Šä¼ è‡³ GitHub Actions Artifactsï¼Œå¯åœ¨å³ä¾§ã€ŒArtifactsã€åŒºåŸŸä¸‹è½½ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # åˆ—å‡ºæ‰€æœ‰æ„å»ºçš„æ–‡ä»¶
        echo "### å¯ç”¨å¹³å°:" >> $GITHUB_STEP_SUMMARY
        if [ -f "./artifacts        
        # åŒæ—¶è¾“å‡ºåˆ°æ—¥å¿—
        echo "æ„å»ºå®Œæˆ: CatSeedLogin v${VERSION}"
        echo "æ›´æ–°å†…å®¹: ${CHANGELOG}"

    - name: Upload summary as artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-summary-v${{ github.event.inputs.version || '0.0.1' }}
        path: $GITHUB_STEP_SUMMARY
        retention-days: 30
